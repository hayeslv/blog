黑客虽然拿不到会话密钥，无法破解密文，但可以通过窃听收集到足够多的密文，再尝试着修改、重组后发给网站。因为没有完整性保证，服务器只能 “照单全收”，然后他就可以通过服务器的响应获取进一步的线索，最终就会破解出明文。

另外，黑客也可以伪造身份发布公钥。如果你拿到了假的公钥，混合加密就完全失效了。你以为自己是在和 “某宝” 通信，实际上网线的另一端却是黑客，银行卡号、密码等敏感信息就在 “安全” 的通信过程中被窃取了。

所以，在机密性的基础上还必须加上完整性、身份认证等特性，才能实现真正地安全。



## 摘要算法

实现完整性的手段主要是摘要算法（`Digest Algorithm`），也就是常说的散列函数、哈希函数（`Hash Function`）。

你可以把**摘要算法**理解为一种特殊的**压缩算法**，它能够把任意长度的数据 “压缩” 成固定长度、独一为二的 “摘要” 字符串，就好像是给这段数据生成了一个数字 “指纹”。

换一个角度，也可以把摘要算法理解成特殊的 “单向” 加密算法，它只有算法，没有密钥，加密后的数据无法解密，不能从摘要逆推出原文。

**摘要算法**实际上是把数据从一个 “大空间” 映射倒了 “小空间”，所以就存在 “冲突”（`collision`，也叫碰撞）的可能性，就如同现实中的指纹一样，可能会有两份不同的原文对应相同的摘要。好的摘要算法必须能够 “抵抗冲突”，让这种可能性尽量地小。

因为**摘要算法**对输入具有 “**单向性**” 和 “**雪崩效应**”，输入的微小不同会导致输出的剧烈变化，所以也被 `TSL` 用来生成伪随机数（`PRF`，`pseudo random function`）。

你一定在日常工作中听过、或者用过 `MD5（Message-Digest 5）`、`SHA-1（Secure Hash Algorithm 1）`，它们就是最常用的两个摘要算法，能够生成 16 字节和 20 字节长度的数字摘要。但这两个算法的**安全强度比较低**，不够安全，在 `TLS` 里已经被禁止使用了。

目前 TLS 推荐使用的是 `SHA-1` 的后继者：`SHA-2`。

`SHA-2` 实际上是一系列摘要算法的统称，总共有 6 种，常用的有 `SHA224、SHA256、SHA384`，分别能够生成 28 字节、32 字节、48 字节的摘要。



## 完整性

摘要算法保证了 “数字摘要” 的原文是完全等价的。所以，我们只要在原文后附上它的摘要，就能够保证数据的完整性。

比如，你发了条信息 “转账 1000 元”，然后再加上一个 `SHA-2` 的摘要。网站收到后也计算一下消息的摘要，把这两份 “指纹” 做个对比，如果一致，就说明消息是完整可信的，没有被修改。

如果黑盒在中间哪怕改动了一个标点符号，摘要也会完全不同，网站计算对比就会发现消息被篡改，是不可信的。

不过摘要算法不具有机密性，如果明文传输，那么黑客可以修改消息后把摘要也一起改了，网站还是鉴别不出完整性。

所以，真正地完整性必须要建立在机密性之上，在混合加密系统里用会话密钥加密消息和摘要，这样黑客无法得知明文，也就没有办法动手脚了。

这有个术语，叫哈希消息认证码（`HMAC`）。

<img src=".\assets\29.png" alt="29" style="zoom:50%;" />



## 数字签名

加密算法结合摘要算法，我们的通信过程可以说是比较安全了。但这里还有讴歌漏洞，就是通信的两个端点（`endpoint`）。

就像一开始所说的，黑客可以伪装成网站来窃取信息。而反过来，他也可以伪装成你，向网站发送支付、转账等消息，网站没有办法确认你的身份，钱可能就这样被偷走了。

现实生活中，解决身份认证的手段是签名和印章，只要在纸上写下签名或者盖个章，就能够证明这份文件确实是由本人而不是其他人发出的。

在 `TSL` 中，**非对称加密的私钥**就是只有本人才能够持有，使用私钥再加上摘要算法，就能够实现 “数字签名”，同时实现 “身份认证” 和 “不可否认”

https://interview2.poetries.top/docs/fe-base/http-protocol/advance/21-%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E4%B8%8E%E8%AF%81%E4%B9%A6.html#%E5%AE%8C%E6%95%B4%E6%80%A7





































